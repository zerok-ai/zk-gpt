name: helm-publish
on:
  workflow_call:
    inputs:
      HELM_VERSION:
        type: string
        required: true
      DOCKER_IDENTIFIER:
        type: string
        required: true
      ENVIRONMENT:
        type: string
        default: 'poc'
env:
  HELM_VERSION: ${{ inputs.HELM_VERSION }}
  ENVIRONMENT: ${{ inputs.ENVIRONMENT }}
  DOCKER_REG: ${{ vars.DOCKER_REG }}
  PROJECT_ID: ${{ vars.PROJECT_ID }}
  DOCKER_REPO: ${{ vars.DOCKER_REPO }}
  DOCKER_IDENTIFIER: ${{ inputs.DOCKER_IDENTIFIER }}

jobs:
  helm-publish:
    runs-on: zk-self-hosted
    environment:
      name: ${{ inputs.ENVIRONMENT }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: docker-tag
        run: |-
          chmod +x helm-charts/rename-docker-tag.sh
          helm-charts/rename-docker-tag.sh $HELM_VERSION

      - name: docker-repo
        run: |-
          chmod +x helm-charts/rename-docker-repo.sh
          helm-charts/rename-docker-repo.sh $DOCKER_REG/$PROJECT_ID/$DOCKER_REPO/$DOCKER_IDENTIFIER
      - name: helm package
        run: |-
              helm dependency update helm-charts
              helm package --version $HELM_VERSION helm-charts
      - name: helm index
        run: |-
              helm repo index ./ --url https://helm.zerok.ai/zk-client/${{ vars.APP_NAME }}/